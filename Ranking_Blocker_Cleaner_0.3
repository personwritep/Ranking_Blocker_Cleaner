// ==UserScript==
// @name        Ranking Blocker Cleaner
// @namespace        http://tampermonkey.net/
// @version        0.3
// @description        Ranking Blocker ã®ãƒ–ãƒ­ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é€€ä¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤
// @author        Ameba Blog User
// @match        https://ameblo.jp/*
// @exclude        https://ameblo.jp/personwritep/entry-12872529591.html
// @icon        https://www.google.com/s2/favicons?sz=64&domain=ameba.jp
// @noframes
// @grant        none
// ==/UserScript==


let block_id=[]; // ãƒ–ãƒ­ãƒƒã‚¯IDã®é…åˆ—ãƒ‡ãƒ¼ã‚¿
let task=0; // ä½œæ¥­ã®æ®µéš
let taikai=0; // é€€ä¼šã—ãŸä¼šå“¡æ•°


main();


function main(){
    let help_url='https://ameblo.jp/personwritep/entry-12872529591.html'

    let SVG_h=
        '<svg class="svg_help" height="22" width="22"  viewBox="0 0 200 200">'+
        '<path d="M89 22C71 25 54 33 41 46C7 81 11 142 50 171C58 177 68 182 78 18'+
        '5C90 188 103 189 115 187C126 185 137 181 146 175C155 169 163 162 169 153'+
        'C190 123 189 80 166 52C147 30 118 18 89 22z" style="fill:#888;"></path>'+
        '<path d="M67 77C73 75 78 72 84 70C94 66 114 67 109 83C106 91 98 95 93 10'+
        '1C86 109 83 116 83 126L111 126C112 114 122 108 129 100C137 90 141 76 135'+
        ' 64C127 45 101 45 84 48C80 49 71 50 68 54C67 56 67 59 67 61L67 77M85 143'+
        'L85 166L110 166L110 143L85 143z" style="fill:#fff;"></path>'+
        '</svg>';


    let inner=
        '<div id="modal">'+
        '<div id="menu_RBC">'+

        '<div class="menu_inner1">'+
        '<div class="inner_RBC">'+
        '<input id="button1" type="submit" value="ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼ã¿">'+
        '<input id="button2" type="file">'+
        '<span class="result_disp"></span>'+
        '</div>'+
        '<div class="inner_RBC">'+
        '<input id="button3" type="submit" value="é€€ä¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒã‚§ãƒƒã‚¯">'+
        '<span class="result_disp"></span>'+
        '</div>'+
        '<div class="inner_RBC">'+
        '<input id="button4" type="submit" value="ä¸è¦ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã¨ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜">'+
        '<span class="result_disp"></span>'+
        '</div>'+
        '<div class="inner_RBC">'+
        '<span class="result_disp"></span>'+
        '</div>'+
        '<div>'+
        '<a href="'+ help_url +'" target="_blank" rel="noopener noreferrer">'+
        SVG_h +'</a>'+
        '<input id="button0" type="submit" value="âœ–">'+
        '</div></div>'+

        '<div class="menu_inner2">'+
        '<ul></ul>'+
        '</div></div>'+

        '<style>'+
        'html { overflow: hidden; } '+
        '#modal { position: fixed; top: 0; left: 0; z-index: 6000; width: 100%; height: 100%; } '+
        '#menu_RBC { position: absolute; top: 70px; left: calc(50% - 200px); '+
        'display: flex; flex-direction: column; padding: 12px 15px; box-sizing: border-box; '+
        'font: normal 16px/16px Meiryo; color: #000; background: #d8e8f0; '+
        'border: 1px solid #aaa; box-shadow: 0 0 0 100vw #00000080; } '+
        '#menu_RBC .menu_inner1 { display: flex; '+
        'justify-content: space-between; align-items: center; margin-bottom: 12px; } '+
        '#menu_RBC .menu_inner2 { height: calc(100vh - 240px); '+
        'width: 400px; padding: 8px 0; background: #fafafa; } '+
        '#menu_RBC ul { height: 100%; overflow-y: scroll; padding: 0px 8px; } '+
        '#menu_RBC li { padding: 3px 0 3px 12px; margin: 1px 0; white-space: nowrap; } '+
        '#menu_RBC .db0 { display: inline-block; width: 50px; text-align: left; } '+
        '#menu_RBC .db1 { display: inline-block; white-space: nowrap; } '+
        '#menu_RBC input { '+
        'font: normal 15px/22px Meiryo; height: 30px; padding: 3px 8px 0; } '+
        '#menu_RBC input.hide { width: 0; padding: 3px 0 0; border: none; } '+
        '#menu_RBC #button2 { display: none; } '+
        '#menu_RBC .result_disp { font: normal 15px/22px Meiryo; margin-left: 15px; } '+
        '#menu_RBC #button0 { width: 27px; padding: 3px 6px 0; } '+
        '#menu_RBC .svg_help { margin: 0 6px -5px; } '+
        '</style></div>';

    if(!document.querySelector('#menu_RBC')){
        document.body.insertAdjacentHTML('beforeend', inner); }


    let menu_RBC=document.querySelector('#menu_RBC');
    if(menu_RBC){
        do_task(); }

} // main()



function do_task(){

    if(task==0){
        task_menu(task);
        close_menu();

        let button1=document.querySelector('#button1');
        let button2=document.querySelector('#button2');
        if(button1 && button2){
            button1.onclick=()=>{
                button2.click(); }

            button2.addEventListener("change" , function(){
                if(!(button2.value)) return; // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œãªã„å ´åˆ
                let file_list=button2.files;
                if(!file_list) return; // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆãŒé¸æŠã•ã‚Œãªã„å ´åˆ
                let file=file_list[0];
                if(!file) return; // ãƒ•ã‚¡ã‚¤ãƒ«ãŒç„¡ã„å ´åˆ

                let file_reader=new FileReader();
                file_reader.readAsText(file);
                file_reader.onload=function(){
                    if(file_reader.result.slice(0, 7)=='["tmp1"'){ // ranking_bl.jsonã®ç¢ºèª
                        let data_in=JSON.parse(file_reader.result);
                        block_id=data_in; // èª­è¾¼ã¿
                        disp_list();

                        task=1;
                        do_task(); }
                    else{
                        let str=' â›” ãƒ•ã‚¡ã‚¤ãƒ«åã¯ã€Œranking_bl (n).jsonã€å½¢å¼ã§ã™ã€€';
                        set_result(str); }};

                setTimeout(()=>{
                    this.value=null; // åŒãƒ•ã‚¡ã‚¤ãƒ«ã®å†èª­è¾¼ã¿ã‚’å¯èƒ½ã«ã™ã‚‹
                }, 1000);

            }); }
    } // if(task==0)



    if(task==1){
        task_menu(task);
        close_menu();

        let str='å…¨ä»¶æ•° ['+ (block_id.length-2) +']';
        set_result(str);

        let button3=document.querySelector('#button3');
        if(button3){
            button3.onclick=()=>{
                button3.classList.add('hide');
                let str='ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€€ã€€èª¿æŸ»ä¸­ ['+ (block_id.length-2) +']';
                set_result(str);
                setTimeout(()=>{
                    taikai=cleaner();
                    task=2;
                    do_task();
                }, 100);
            }}

    } // if(task==1)



    if(task==2){
        task_menu(task);
        close_menu();

        let str='é€€ä¼šæ•° ['+ taikai +']';
        set_result(str);

        let button4=document.querySelector('#button4');
        if(button4){
            button4.onclick=()=>{

                if(taikai>0){
                    delete_data();

                    if(block_id.length>2){
                        let write_json=JSON.stringify(block_id);
                        let blob=new Blob([write_json], {type: 'application/json'});
                        let a=document.createElement("a");
                        a.href=URL.createObjectURL(blob);
                        document.body.appendChild(a);
                        a.download='ranking_bl.json';
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(a.href); }

                    task=3;
                    do_task(); }

                else{
                    alert(
                        ' ğŸŸ¢ ãƒ•ã‚¡ã‚¤ãƒ«ã®ç™»éŒ²ãƒ‡ãƒ¼ã‚¿ã«é€€ä¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“\n'+
                        'ã€€ã€€ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã¯ä¸è¦ãªã®ã§ã€ãƒ„ãƒ¼ãƒ«ã‚’çµ‚äº†ã—ã¦ãã ã•ã„ã€‚'); }
            }}

    } // if(task==2)



    if(task==3){
        task_menu(task);
        close_menu();

        let str='ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸã€€å…¨ä»¶æ•°['+ (block_id.length-2) +']';
        set_result(str);

        disp_list();

    } // if(task==3)

} // do_task()



function task_menu(n){
    let inner_RBC=document.querySelectorAll('.inner_RBC');
    for(let k=0; k<inner_RBC.length; k++){
        inner_RBC[k].style.display='none'; }
    inner_RBC[n].style.display='block'; }



function close_menu(){
    let modal=document.querySelector('#modal');
    let button0=document.querySelector('#button0');
    if(button0 && modal){
        button0.onclick=()=>{
            modal.remove(); }}}



function set_result(str){
    let result_disp=document.querySelectorAll('.result_disp')[task];
    if(result_disp){
        result_disp.innerHTML=str; }}



function disp_list(){
    let ul=document.querySelector('#menu_RBC ul');
    if(ul){
        ul.innerHTML=''; // ãƒªã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹

        for(let k=0; k<2; k++){
            let li=
                '<li>'+
                '<span class="db0">--</span>'+
                '<span class="db1">'+ block_id[k] +'</span>'+
                '</li>';
            ul.insertAdjacentHTML('beforeend', li ); }

        for(let k=2; k<block_id.length; k++){
            let li=
                '<li>'+
                '<span class="db0">'+ (k-1) +'</span>'+
                '<span class="db1">'+ block_id[k] +'</span>'+
                '</li>';
            ul.insertAdjacentHTML('beforeend', li );
        }}

} // disp_list()



function cleaner(){
    let count=0;

    let ul_li=document.querySelectorAll('#menu_RBC ul li');
    if(ul_li.length>3){ // block_id=['tmp1', '%Ameba-ID', 'xxxxxx', ]
        for(let k=2; k<ul_li.length; k++){
            let id=ul_li[k].querySelector('.db1').textContent;
            if(id){
                if(check_id(id)){
                    count+=1;
                    ul_li[k].style.background='#2196f395'; }}} // if(ul_li.length>3)

        return count; }
    else{
        alert(
            " â›” ãƒ–ãƒ­ãƒƒã‚¯ã®ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“\n\n"+
            "ã€€ã€€ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦åˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­è¾¼ã‚€ã‹\n"+
            "ã€€ã€€ã“ã®ã‚¯ãƒªãƒ¼ãƒŠãƒ¼ãƒ„ãƒ¼ãƒ«ã‚’çµ‚äº†ã—ã¦ãã ã•ã„");
        return 0; }



    function check_id(id){
        let url='https://ameblo.jp/'+ id;
        if(load(url)!=200){
            return true; } // target_urlãŒç„¡ã„æ™‚ã« true

        function load(_url){
            let xhr;
            xhr=new XMLHttpRequest();
            xhr.open("HEAD", _url, false); // åŒæœŸãƒ¢ãƒ¼ãƒ‰
            xhr.send();
            return xhr.status; }}

} // cleaner()



function delete_data(){
    let clean_block_id=[];

    let ul_li=document.querySelectorAll('#menu_RBC ul li');
    for(let k=0; k<ul_li.length; k++){
        if(ul_li[k].hasAttribute('style')){
            ul_li[k].remove(); }
        else{
            let id=ul_li[k].querySelector('.db1').textContent;
            if(id){
                clean_block_id.push(id); }}}

    block_id=clean_block_id;

} // delete_data()


